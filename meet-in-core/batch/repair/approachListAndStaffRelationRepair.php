<?php
/**
 * Created by PhpStorm.
 * User: matsuno.masahiro
 * Date: 2016/02/19
 * Time: 17:14
 */

// DB接続
include_once dirname(__FILE__)."/../function/CommonMigration.php";


// 対象となるクライアント
$targetClientStr = " 310, 314, 349, 467, 501, 621, 655, 672 ";

/**
 * DBへの接続を試みる
 * @var unknown_type
 */
try{
    // DAO読み込み時のエラー回避のため、空のarrayをセットする
    Zend_Registry::set('user', array());

//    // 現行TMOのDBのインスタンス作成
//    $currentDb = getCurrentDbObject();
    // 移行先DBのインスタンス作成
    $destinationDb = getNewDbObject();

}
catch (Exception $err){
    debugMeg("error:".$err->getMessage());
}



debugMeg("----approach_list_and_staff_relation Repair STAR22T----");

// AAスタッフID変換係数
$aaConvertArray = array(
    31=>283,32=>284,33=>285,34=>286,35=>287,36=>288,37=>289,38=>290,39=>291,40=>292,41=>293,42=>294,43=>295,44=>296,45=>297,46=>298,47=>299,48=>300,49=>301,50=>302,51=>303,52=>304,53=>305,54=>306,55=>307,56=>308,57=>309,58=>310,59=>311,60=>312,
    61=>313,62=>314,63=>315,64=>316,65=>317,66=>318,67=>319,68=>320,69=>321,70=>322,71=>323,72=>324,73=>325,74=>326,75=>327,76=>328,77=>329,78=>330,79=>331,80=>332,81=>333,82=>334,83=>335,84=>336,85=>337,86=>338,87=>339,88=>340,89=>341,90=>342,
    91=>343,92=>344,93=>345,94=>346,95=>347,96=>348,97=>349,98=>350,99=>351,100=>352,101=>353,102=>354,103=>355,104=>356,105=>357,106=>358,107=>359,108=>360,109=>361,110=>362,111=>363,112=>364,113=>365,114=>366,115=>367,116=>368,117=>369,118=>370,119=>371,120=>372,
    121=>373,122=>374,123=>375,124=>376,125=>377,126=>378,127=>379,128=>380,129=>381,130=>382,131=>383,132=>384,133=>385,134=>386,135=>387,136=>388,137=>389,138=>390,139=>391,140=>392,141=>393,142=>394,143=>395,144=>396,145=>397,146=>398,147=>399,148=>400,149=>401,150=>402,
    151=>403,152=>404,153=>405,154=>406,155=>407,156=>408,157=>409,158=>410,159=>411,160=>412,161=>413,162=>414,163=>415,164=>416,165=>417,166=>418,167=>419,168=>420,169=>421,170=>422,171=>423,172=>424,173=>425,174=>426,175=>427,176=>428,177=>429,178=>430,179=>431,180=>432,
    181=>433,182=>434,183=>435,184=>436,185=>437,186=>438,187=>439,188=>440,189=>441,190=>442,191=>443,192=>444,193=>445,194=>446,195=>447,196=>448,197=>449,198=>450,199=>451,200=>452,201=>453,202=>454,203=>455,204=>456,205=>457,206=>458,207=>459,208=>460,209=>461,210=>462,
    211=>463,212=>464,213=>465,214=>466,215=>467,216=>468,217=>469,218=>470,219=>471,220=>472,221=>473,222=>474,223=>475,224=>476,225=>477,226=>478,227=>479,228=>480,229=>481,230=>482,231=>483,232=>484,233=>485,234=>486,235=>487,236=>488,237=>489,238=>490,239=>491,240=>492,
    241=>493,242=>494,243=>495,244=>496,245=>497,246=>498,247=>499,248=>500,249=>501,250=>502,251=>503,252=>504,253=>505,254=>506,255=>507,256=>508,257=>509,258=>510,259=>511,260=>512,261=>513,262=>514,263=>515,264=>516,265=>517,266=>518,267=>519,268=>520,269=>521,270=>522,271=>523,272=>524,273=>525,274=>526,275=>527,276=>528,277=>529,278=>530,279=>531,280=>532,
    281=>533,282=>534,283=>535,284=>536,285=>537,286=>538,287=>539,288=>540,289=>541,290=>542,291=>543,292=>544,293=>545,294=>546,295=>547,296=>548,297=>549,298=>550,299=>551,300=>552,301=>553,302=>554,303=>555,304=>556,305=>557,306=>558,307=>559,308=>560,309=>561,310=>562,
    311=>563,312=>564,313=>565,314=>566,315=>567,316=>568,317=>569,318=>570,319=>571,320=>572,321=>573,322=>574,323=>575,324=>576,325=>577,326=>578,327=>579,328=>580,329=>581,330=>582,331=>583,332=>584,333=>585,334=>586,335=>587,336=>588,337=>589,338=>590,339=>591,340=>592,341=>593,
    342=>594,343=>595,344=>596,345=>597,346=>598,347=>599,348=>600,349=>601,350=>602,351=>603,352=>604,353=>605,354=>606,355=>607,356=>608,357=>609,358=>610,359=>611,360=>612,361=>613,362=>614,363=>615,364=>616,365=>617,366=>618,367=>619,368=>620,369=>621,370=>622,371=>623,
    372=>624,373=>625,374=>626,375=>627,376=>628,377=>629,378=>630,379=>631,380=>632,381=>633,382=>634,383=>635,384=>636,385=>637,386=>638,387=>639,388=>640,389=>641,390=>642,391=>643,392=>644,393=>645,394=>646,395=>647,396=>648,397=>649,398=>650,399=>651,400=>652,
    401=>653,402=>654,403=>655,404=>656,405=>657,406=>658,407=>659,408=>660,409=>661,410=>662,411=>663,412=>664,413=>665,414=>666,415=>667,416=>668,417=>669,418=>670,419=>671,420=>672,421=>673,422=>674,423=>675,424=>676,425=>677,426=>678,427=>679,428=>680,429=>681,430=>682,431=>683,
    432=>684,433=>685,434=>686,435=>687,436=>688,437=>689,438=>690,439=>691,440=>692,441=>693,442=>694,443=>695,444=>696,445=>697,446=>698,447=>699,448=>700,449=>701,450=>702,451=>703,452=>704,453=>705,454=>706,455=>707,456=>708,457=>709,458=>710,459=>711,460=>712,461=>713,462=>714,463=>715,464=>716,465=>717,466=>718,467=>719,468=>720,469=>721,470=>722,
    471=>723,472=>724,473=>725,474=>726,475=>727,476=>728,477=>729,478=>730,479=>731,480=>732,481=>733,482=>734,483=>735,484=>736,485=>737,486=>738,487=>739,488=>740,489=>741,490=>742,491=>743,492=>744,493=>745,494=>746,495=>747,496=>748,497=>749,498=>750,499=>751,500=>752,501=>753,502=>754,503=>755,504=>756,505=>757,506=>758,
    507=>759,508=>760,509=>761,510=>762,511=>763,512=>764,513=>765,514=>766,515=>767,516=>768,517=>769,518=>770,519=>771,520=>772,521=>773,522=>774,523=>775,524=>776,525=>777,526=>778,527=>779,528=>780,529=>781,530=>782,531=>783,532=>784,533=>785,534=>786,535=>787,536=>788,537=>789,538=>790,539=>791,540=>792,541=>793,542=>794,
    543=>795,544=>796,545=>797,546=>798,547=>799,548=>800,549=>801,550=>802,551=>803,552=>804,553=>805,554=>806,555=>807,556=>808,557=>809,558=>810,559=>811,560=>812,561=>813,562=>814,563=>815,564=>816,565=>817,566=>818,567=>819,568=>820,569=>821,570=>822,571=>823,572=>824,573=>825,574=>826,575=>827,576=>828,577=>829,578=>830,
    579=>831,580=>832,581=>833,582=>834,583=>835,584=>836,585=>837,586=>838,587=>839,588=>840,589=>841,590=>842,591=>843,592=>844,593=>845,594=>846,595=>847,596=>848,597=>849,598=>850,599=>851,600=>852,601=>853,602=>854,603=>855,604=>856,605=>857,606=>858,607=>859,608=>860,609=>861,610=>862,611=>863,612=>864,613=>865,
    614=>866,615=>867,616=>868,617=>869,618=>870,619=>871,620=>872,621=>873,622=>874,623=>875,624=>876,625=>877,626=>878,627=>879,628=>880,629=>881,630=>882,631=>883,632=>884,633=>885,634=>886,635=>887,636=>888,637=>889,638=>890,639=>891,640=>892,641=>893,642=>894,643=>895,644=>896,645=>897,646=>898,647=>899,648=>900,
    649=>901,650=>902,651=>903,652=>904,653=>905,654=>906,655=>907,656=>908,657=>909,658=>910,659=>911,660=>912,661=>913,662=>914,663=>915,664=>916,665=>917,666=>918,667=>919,668=>920,669=>921,670=>922,671=>923,672=>924,673=>925,674=>926,675=>927,676=>928,677=>929,678=>930,679=>931,680=>932,
    681=>933,682=>934,683=>935,684=>936,685=>937,686=>938,687=>939,688=>940,689=>941,690=>942,691=>943,692=>944,693=>945,694=>946,695=>947,696=>948,697=>949,698=>950,699=>951,700=>952,701=>953,702=>954,703=>955,704=>956,705=>957,706=>958,707=>959,708=>960,709=>961,710=>962,711=>963,
    712=>964,713=>965,714=>966,715=>967,716=>968,717=>969,718=>970,719=>971,720=>972,721=>973,722=>974,723=>975,724=>976,725=>977,726=>978,727=>979,728=>980,729=>981,730=>982,731=>983,732=>984,733=>985,734=>986,735=>987,736=>988,737=>989,738=>990,739=>991,740=>992,741=>993,742=>994,743=>995,744=>996,745=>997,746=>998,
    747=>999,748=>1000,749=>1001,750=>1002,751=>1003,752=>1004,753=>1005
);


// TAスタッフID変換係数
$taConvertArray = array(
    10001=>140,10002=>141,10003=>142,10004=>143,10005=>144,10006=>145,10007=>146,10008=>147,10009=>148,10010=>149,10011=>150,10012=>151,10013=>152,10014=>153,10015=>154,10016=>155,10017=>156,10018=>157,10019=>158,10020=>159,10021=>160,10022=>161,10023=>162,10024=>163,10025=>164,10026=>165,10027=>166,10028=>167,10029=>168,10030=>169,10031=>170,10032=>171,10033=>172,10034=>173,10035=>174,10036=>175,10037=>176,10038=>177,10039=>178,10040=>179,10041=>180,10042=>181,
    10043=>182,10044=>183,10045=>184,10046=>185,10047=>186,10048=>187,10049=>188,10050=>189,10051=>190,10052=>191,10053=>192,10054=>193,10055=>194,10056=>195,10057=>196,10058=>197,10059=>198,10060=>199,10061=>200,10062=>201,10063=>202,10064=>203,10065=>204,10066=>205,10067=>206,10068=>207,10069=>208,10070=>209,10071=>210,10072=>211,10073=>212,10074=>213,10075=>214,10076=>215,10077=>216,10078=>217,10079=>218,10080=>219,10081=>220,10082=>221,10083=>222,10084=>223,10085=>224,10086=>225,10087=>226,10088=>227,10089=>228,10090=>229,10091=>230,10092=>231,10093=>232,
    10094=>233,10095=>234,10096=>235,10097=>236,10098=>237,10099=>238,10100=>239,10101=>240,10102=>241,10103=>242,10104=>243,10105=>244,10106=>245,10107=>246,10108=>247,10109=>248,10110=>249,10111=>250,10112=>251,10113=>252,10114=>253,10115=>254,10116=>255,10117=>256,10118=>257,10119=>258,10120=>259,10121=>260,10122=>261,10123=>262,10124=>263,10125=>264,10126=>265,10127=>266,10128=>267,10129=>268,10130=>269,10131=>270,10132=>271,10133=>272,10134=>273,10135=>274,10136=>275,10137=>276,10138=>277,10139=>278,10140=>279,10141=>280,10142=>281,10143=>282,10144=>283,
    10145=>284,10146=>285,10147=>286,10148=>287,10149=>288,10150=>289,10151=>290,10152=>291,10153=>292,10154=>293,10155=>294,10156=>295,10157=>296,10158=>297,10159=>298,10160=>299,10161=>300,10162=>301,10163=>302,10164=>303,10165=>304,10166=>305,10167=>306,10168=>307,10169=>308,10170=>309,10171=>310,10172=>311,10173=>312,10174=>313,10175=>314,10176=>315,10177=>316,10178=>317,10179=>318,10180=>319,10181=>320,10182=>321,10183=>322,10184=>323,10185=>324,10186=>325,10187=>326,10188=>327,10189=>328,10190=>329,10191=>330,10192=>331,10193=>332,
    10194=>333,10195=>334,10196=>335,10197=>336,10198=>337,10199=>338,10200=>339,10201=>340,10202=>341,10203=>342,10204=>343,10205=>344,10206=>345,10207=>346,10208=>347,10209=>348,10210=>349,10211=>350,10212=>351,10213=>352,10214=>353,10215=>354,10216=>355,10217=>356,10218=>357,10219=>358,10220=>359,10221=>360,10222=>361,10223=>362,10224=>363,10225=>364,10226=>365,10227=>366,10228=>367,10229=>368,10230=>369,10231=>370,10232=>371,10233=>372,10234=>373,
    10235=>374,10236=>375,10237=>376,10238=>377,10239=>378,10240=>379,10241=>380,10242=>381,10243=>382,10244=>383,10245=>384,10246=>385,10247=>386,10248=>387,10249=>388,10250=>389,10251=>390,10252=>391,10253=>392,10254=>393,10255=>394,10256=>395,10257=>396,10258=>397,10259=>398,10260=>399,10261=>400,10262=>401,10263=>402,10264=>403,10265=>404,10266=>405,10267=>406,10268=>407,10269=>408,10270=>409,10271=>410,10272=>411,10273=>412,10274=>413,10275=>414,10276=>415,10277=>416,10278=>417,10279=>418,10280=>419,10281=>420,
    10282=>421,10283=>422,10284=>423,10285=>424,10286=>425,10287=>426,10288=>427,10289=>428,10290=>429,10291=>430,10292=>431,10293=>432,10294=>433,10295=>434,10296=>435,10297=>436,10298=>437,10299=>438,10300=>439,10301=>440,10302=>441,10303=>442,10304=>443,10305=>444,10306=>445,10307=>446,10308=>447,10309=>448,10310=>449,10311=>450,10312=>451,10313=>452,10314=>453,10315=>454,10316=>455,10317=>456,10318=>457,10319=>458,10320=>459,10321=>460,10322=>461,10323=>462,10324=>463,10325=>464,10326=>465,10327=>466,
    10328=>467,10329=>468,10330=>469,10331=>470,10332=>471,10333=>472,10334=>473,10335=>474,10336=>475,10337=>476,10338=>477,10339=>478,10340=>479,10341=>480,10342=>481,10343=>482,10344=>483,10345=>484,10346=>485,10347=>486,10348=>487,10349=>488,10350=>489,10351=>490,10352=>491,10353=>492,10354=>493,10355=>494,10356=>495,10357=>496,10358=>497,10359=>498,10360=>499,10361=>500,10362=>501,10363=>502,10364=>503,10365=>504,10366=>505,10367=>506,10368=>507,10369=>508,10370=>509,10371=>510,10372=>511,10373=>512,10374=>513,10375=>514,10376=>515,10377=>516,10378=>517,10379=>518,
    10380=>519,10381=>520,10382=>521,10383=>522,10384=>523,10385=>524,10386=>525,10387=>526,10388=>527,10389=>528,10390=>529,10391=>530,10392=>531,10393=>532,10394=>533,10395=>534,10396=>535,10397=>536,10398=>537,10399=>538,10400=>539,10401=>540,10402=>541,10403=>542,10404=>543,10405=>544,10406=>545,10407=>546,10408=>547,10409=>548,10410=>549,10411=>550,10412=>551,10413=>552,10414=>553,10415=>554,10416=>555,
);

// データ移行に必要なDAOを宣言
$migrationRepairDao = Application_CommonUtil::getInstance('dao',"MigrationRepairDao", $destinationDb);

// 対象となるデータの取得
$approachListAndStaffRelationList = $migrationRepairDao->getApproachListAndStaffRelation($targetClientStr);


/**
 * @var unknown_type
 */
try{
    // トランザクションスタート
    $destinationDb->beginTransaction();

    foreach($approachListAndStaffRelationList as $approachListAndStaffRelation){

        // 変換リストに名前があったら変換
        if($approachListAndStaffRelation["approach_list_staff_type"] == "AA"){
            if(isset($aaConvertArray[$approachListAndStaffRelation["approach_list_staff_id"]])){
                $approachListAndStaffRelation["new_approach_list_staff_id"] = $aaConvertArray[$approachListAndStaffRelation["approach_list_staff_id"]];
            }
        }else if($approachListAndStaffRelation["approach_list_staff_type"] == "TA"){
            if(isset($taConvertArray[$approachListAndStaffRelation["approach_list_staff_id"]])){
                $approachListAndStaffRelation["new_approach_list_staff_id"] = $taConvertArray[$approachListAndStaffRelation["approach_list_staff_id"]];
            }
        }



        $approachListAndStaffRelationData = array(
            "client_id" => $approachListAndStaffRelation["client_id"],
            "approach_list_id" => $approachListAndStaffRelation["approach_list_id"],
            "approach_list_staff_type" => $approachListAndStaffRelation["approach_list_staff_type"],
            "approach_list_staff_id" => $approachListAndStaffRelation["approach_list_staff_id"],
            "new_approach_list_staff_id" => $approachListAndStaffRelation["new_approach_list_staff_id"]
        );

        // 空なら変換の必要はないのでスルー
        if(isset($approachListAndStaffRelation["new_approach_list_staff_id"])){
            debugMeg($approachListAndStaffRelation["approach_list_staff_id"] ." => ".$approachListAndStaffRelation["new_approach_list_staff_id"]);
            $migrationRepairDao->updateApproachListAndStaffRelation($approachListAndStaffRelationData);
        }
    }
    // 登録完了したらコミットする
    $destinationDb->commit();
}
catch (Exception $err){
    $destinationDb->rollBack();
    debugMeg("想定外の例外：".$err->getMessage());
}


debugMeg("----approach_list_and_staff_relation Repair END----");
